# Kenzan laptop specific .bashrc settings
# Should be sourced by .bashrc

# Places
alias projects='cd ~/Documents/projects'
alias training='cd ~/Documents/projects/training'
alias blue='cd ~/Documents/projects/blue-team'
alias notes='cd "${notes}"'

# Apps
alias chrome='/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome'
alias google='chrome'

# Clear IntelliJ 'ignored files' list that's created when deleting an Intellij Maven module
function restore_intellij_modules() {
	xmlstarlet ed -P -L -d '/project/component/option[@name="ignoredFiles"]' /code/BlueTeam/.idea/misc.xml
}

# Early days at Kenzan
alias accounts="vi '${notes}/accounts.txt'"
alias todo="vi '${notes}/todo.txt'"
alias gather='"${code}"/elspleth/machines/scripts/gather_machine_rc.sh kenzan_laptop'

# Charter
alias exercisedockerprovisioning='"${code}"/elspleth-charter/scripts/exercise_docker_provisioning.sh'
alias exercisedockerprovisioningundo='"${code}"/elspleth-charter/scripts/exercise_docker_provisioning_undo.sh'
alias dp='cd "${code}"/docker-provisioning'

function open_pages() {
	echo "Opening..."
	for i in "$@"; do
		echo "${i}"
		open "${i}"
	done
}

function get_charter_project_name_from_git() {
	if [ ! -d .git ]; then echo "Change to root Git project directory"; return 1; fi
	local url=$(git config remote.origin.url)
	# extract the protocol
	local proto="$(echo $url | grep :// | sed -e's,^\(.*://\).*,\1,g')"
	# remove the protocol
	local url="$(echo ${url/$proto/})"
	# extract the user (if any)
	local user="$(echo $url | grep @ | cut -d@ -f1)"
	# extract the host
	local host="$(echo ${url/$user@/} | cut -d/ -f1)"
	# by request - try to extract the port
	local port="$(echo $host | sed -e 's,^.*:,:,g' -e 's,.*:\([0-9]*\).*,\1,g' -e 's,[^0-9],,g')"
	# extract the path (if any)
	local path="$(echo $url | grep / | cut -d/ -f2-)"

	local second_to_last_path_component="$(echo $path | rev | cut -d/ -f2 | rev)"
	echo "${second_to_last_path_component}"
}

function bitbucket() {
	if [ ! -d .git ]; then echo "Change to root Git project directory"; return 1; fi
	local current_branch_name="$(git rev-parse --abbrev-ref HEAD)"
	local repo_name="$(basename $(pwd))"
	local bitbucket_base="https://stash.dev-charter.net"

	local charter_project="$(get_charter_project_name_from_git)"
	local repo_base="${bitbucket_base}/stash/projects/${charter_project}/repos"

	# https://stash.dev-charter.net/stash/projects/SPC/repos/equipment-chtr-data-manager-config/browse
	# https://stash.dev-charter.net/stash/projects/SPC/repos/equipment-chtr-data-manager-config/pull-requests?create
	# https://stash.dev-charter.net/stash/projects/SPCLIB/repos/helloworld-java-lib/browse
	local pages=()
	local pages+=("${repo_base}/${repo_name}/browse")
	local pages+=("${repo_base}/${repo_name}/pull-requests?create")
	echo "On branch ${current_branch_name}"
	open_pages "${pages[@]}"
}

function jenkins() {
	if [ ! -d .git ]; then echo "Change to root Git project directory"; return 1; fi
	local current_branch_name="$(git rev-parse --abbrev-ref HEAD)"
	local charter_project="$(get_charter_project_name_from_git)"
	local job_name="${charter_project}-$(basename $(pwd))"
	echo "Opens Jenkins pages for ${job_name}"
	echo "Usage: jenkins [optional single page position, 1 through n otherwise all] [optional branch name]"
	echo
	local jenkins_base="https://jenkinsdocker.dev-charter.net"
	local job_home="${jenkins_base}/job/${job_name}"
	local pages=("${job_home}")
	if [ "$2" ]; then
		local branch_name="$1"
	else
		# Escape forward-slash in branch name for use in URLs
		local branch_name="${current_branch_name/\//%252F}"
	fi
	local pages+=("${job_home}/job/${branch_name}")
	local pages+=("${job_home}/job/${branch_name}/build?delay=0sec")
	if [ -n "$1" -a $1 -gt 0 -a $1 -le ${#pages[@]} ]; then
		local page=$1
		let "page--"
		open_pages "${pages[$page]}"
	else
		open_pages "${pages[@]}"
	fi
}

# auto-complete
if [ -f $(brew --prefix)/etc/bash_completion ]; then
. $(brew --prefix)/etc/bash_completion
fi

# Added by NVM installation
function nvmcli() {
	export NVM_DIR="$HOME/.nvm"
	[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
	[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
}
MANPATH="/usr/local/opt/coreutils/libexec/gnuman:$MANPATH"

function change_java_version() {
	if [ $# -ne 1 ]; then
		echo "Usage: change_java_version <version number>"
	else
		sed -i bak -e 's/.*export JAVA_HOME=.*/export JAVA_HOME=\`\/usr\/libexec\/java_home -v '"$1"'\`/g' ~/.bash_profile
		source ~/.bash_profile
		echo "JAVA_HOME: ${JAVA_HOME}"
		java -version
	fi
}
alias java8='change_java_version 1.8'
alias java10='change_java_version 10'

# Clears annoying Iterm2 introduction
clear

